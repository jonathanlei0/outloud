const g="sk_car_tHc1wiPDq4xLTPvtswDpNA";console.log("üîë Cartesia API key loaded:",`${g.substring(0,10)}...`);const s=class s{static async generateSpeech(e){console.log("üéØ CartesiaService.generateSpeech called"),console.log("Request:",{text:e.text.substring(0,50)+"...",voiceId:e.voiceId,speed:e.speed,language:e.language});const r=e.language||"en";let o=e.voiceId;if(!o){const n=s.VOICES.find(i=>i.language===r);o=(n==null?void 0:n.id)||s.VOICES[0].id}console.log("üéµ Using voice:",o,"for language:",r),console.log("üèÉ Speed setting:",e.speed);const a={model_id:"sonic-turbo",transcript:e.text,voice:{mode:"id",id:o},output_format:{container:"mp3",bit_rate:128e3,sample_rate:44100},language:r==="zh"?"zh":"en",speed:e.speed};console.log("üìã Request body:",JSON.stringify(a,null,2));try{console.log("üåê Making fetch request to:",`${s.API_BASE}/tts/bytes`);const n=await fetch(`${s.API_BASE}/tts/bytes`,{method:"POST",headers:{"Cartesia-Version":s.API_VERSION,Authorization:`Bearer ${g}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(console.log("üì° Response status:",n.status),console.log("üì° Response headers:",n.headers),!n.ok){const c=await n.text();throw console.error("‚ùå API Error Response:",c),new Error(`Cartesia API error: ${n.status} ${n.statusText} - ${c}`)}const i=await n.arrayBuffer();return console.log("‚úÖ Successfully received audio buffer:",i.byteLength,"bytes"),i}catch(n){throw console.error("‚ùå Error calling Cartesia API:",n),n}}static getVoices(){return s.VOICES}static getVoicesForLanguage(e){return s.VOICES.filter(r=>r.language===e)}};s.API_BASE="https://api.cartesia.ai",s.API_VERSION="2025-04-16",s.VOICES=[{id:"694f9389-aac1-45b6-b726-9d9369183238",name:"Default Voice",language:"en",gender:"neutral"},{id:"a0e99841-438c-4a64-b679-ae501e7d6091",name:"British Male",language:"en",gender:"male"},{id:"2ee87190-8f84-4925-97da-e52547f9462c",name:"American Female",language:"en",gender:"female"},{id:"820a3788-2b37-4d21-847a-b65d8a68c99a",name:"Australian Male",language:"en",gender:"male"},{id:"87748186-23bb-4158-a1eb-332911b0b708",name:"‰∏≠ÊñáÂ•≥Â£∞",language:"zh",gender:"female"},{id:"b9de4a89-2f3e-4f5c-9b8d-7c4a6b2f8e3d",name:"‰∏≠ÊñáÁî∑Â£∞",language:"zh",gender:"male"},{id:"c8ef5b9a-3f4e-5f6d-ac9e-8d5a7c3f9e4f",name:"Âè∞ÊπæÂ•≥Â£∞",language:"zh",gender:"female"}];let u=s;chrome.runtime.onMessage.addListener((t,e,r)=>t.type==="SPEAK_TEXT"?(console.log("üé§ Background received SPEAK_TEXT message:",t.text.substring(0,50)+"..."),m(t,r),!0):t.type==="STOP_SPEAKING"?(h(r),!0):!1);async function d(t){return new Promise(e=>{chrome.tabs.sendMessage(t,{type:"PING"},r=>{chrome.runtime.lastError?(console.log("Content script not ready, attempting to inject..."),chrome.scripting.executeScript({target:{tabId:t},files:["content.js"]},()=>{chrome.runtime.lastError?(console.error("Failed to inject content script:",chrome.runtime.lastError.message),e(!1)):(console.log("Content script injected, testing again..."),setTimeout(()=>{chrome.tabs.sendMessage(t,{type:"PING"},o=>{e(!chrome.runtime.lastError)})},100))})):(console.log("Content script already ready"),e(!0))})})}async function p(t,e,r=3){for(let o=1;o<=r;o++){if(console.log(`üì§ Attempt ${o}/${r}: Sending audio to content script in tab:`,t),await new Promise(a=>{chrome.tabs.sendMessage(t,{type:"PLAY_AUDIO",audioData:e,mimeType:"audio/mpeg"},n=>{chrome.runtime.lastError?(console.error(`‚ùå Attempt ${o} failed:`,chrome.runtime.lastError.message),a(!1)):(console.log(`‚úÖ Attempt ${o} succeeded: Audio sent to content script`),a(!0))})}))return!0;o<r&&(console.log("üîÑ Retrying... ensuring content script is ready first"),await d(t),await new Promise(a=>setTimeout(a,200)))}return!1}async function m(t,e){var r,o,l;try{const a={text:t.text,voiceId:(r=t.options)==null?void 0:r.voice,speed:((o=t.options)==null?void 0:o.speed)||"normal",language:((l=t.options)==null?void 0:l.language)||"en"};console.log("üîä Generating speech with Cartesia for:",t.text.substring(0,50)+"..."),console.log("Voice ID:",a.voiceId||"auto-select"),console.log("Speed:",a.speed),console.log("Language:",a.language),console.log("üì° Calling Cartesia API...");const n=await u.generateSpeech(a);console.log("‚úÖ Received audio buffer:",n.byteLength,"bytes"),console.log("üîÑ Converting to base64...");const i=y(n);console.log("‚úÖ Base64 conversion complete:",i.length,"characters");const[c]=await chrome.tabs.query({active:!0,currentWindow:!0});if(c!=null&&c.id){if(!await d(c.id)){console.error("‚ùå Could not prepare content script"),e({success:!1,error:"Could not prepare audio playback. Make sure you're on a regular webpage."});return}const f=await p(c.id,i);e(f?{success:!0}:{success:!1,error:"Could not play audio. Make sure you're on a regular webpage and try again."})}else console.error("‚ùå No active tab found"),e({success:!1,error:"No active tab found"})}catch(a){console.error("‚ùå Error generating speech:",a),e({success:!1,error:a instanceof Error?a.message:"Unknown error"})}}async function h(t){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e!=null&&e.id?chrome.tabs.sendMessage(e.id,{type:"STOP_AUDIO"},r=>{chrome.runtime.lastError?(console.error("Error sending stop message to content script:",chrome.runtime.lastError.message),t({success:!0})):t({success:!0})}):t({success:!0})}catch(e){console.error("Error stopping speech:",e),t({success:!1,error:e instanceof Error?e.message:"Unknown error"})}}function y(t){const e=new Uint8Array(t);let r="";for(let o=0;o<e.byteLength;o++)r+=String.fromCharCode(e[o]);return btoa(r)}chrome.action.onClicked.addListener(t=>{});console.log("OutLoud background service worker loaded with Cartesia TTS");
