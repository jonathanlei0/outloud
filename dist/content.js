function A(e){if(!e||e.trim().length===0)return{language:"en",confidence:0};const n=e.trim(),o=/[\u4e00-\u9fff]/g,r=n.match(o),c=r?r.length:0,i=/[a-zA-Z]/g,l=n.match(i),u=l?l.length:0,m=/[\u4e00-\u9fff]|[a-zA-Z]/g,g=n.match(m),d=g?g.length:0;if(d===0)return{language:"en",confidence:.1};const f=c/d,h=u/d;return f>.3?{language:"zh",confidence:Math.min(.9,.5+f)}:h>.7?{language:"en",confidence:Math.min(.9,.5+h)}:c>u?{language:"zh",confidence:.6}:{language:"en",confidence:.6}}let t=null,a={autoRead:!1,languageDetection:"auto",speed:"normal",voice:""};chrome.storage.local.get(["voiceSettings"]).then(e=>{e.voiceSettings&&(a={...a,...e.voiceSettings},console.log("üîß Auto-read settings loaded:",a))});document.addEventListener("mouseup",()=>{var n;const e=(n=window.getSelection())==null?void 0:n.toString().trim();e&&e.length>0&&(chrome.storage.local.set({lastSelectedText:e}),a.autoRead&&(console.log("ü§ñ Auto-read triggered for:",e.substring(0,50)+"..."),console.log("üèÉ Using speed setting:",a.speed),p(e)))});function p(e){let n;if(a.languageDetection==="auto"){const o=A(e);n=o.language,console.log("üîç Language detected:",n,`(${Math.round(o.confidence*100)}% confidence)`)}else n=a.languageDetection,console.log("üîß Language forced to:",n);console.log("üéµ Auto-read will use settings:",{speed:a.speed,voice:a.voice||"auto-select",language:n}),chrome.runtime.sendMessage({type:"SPEAK_TEXT",text:e,options:{...a,language:n}},o=>{chrome.runtime.lastError?console.error("Error in auto-read:",chrome.runtime.lastError.message):o&&!o.success?console.error("Auto-read failed:",o.error):console.log("‚úÖ Auto-read successful with speed:",a.speed)})}document.addEventListener("keydown",e=>{var n;if((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key==="S"){e.preventDefault();const o=(n=window.getSelection())==null?void 0:n.toString().trim();o&&(console.log("‚å®Ô∏è Keyboard shortcut triggered with speed:",a.speed),p(o))}});chrome.runtime.onMessage.addListener((e,n,o)=>{var r;if(e.type==="PING")return o({ready:!0}),!0;if(e.type==="PLAY_AUDIO")return console.log("Content script received PLAY_AUDIO message"),console.log("Audio data length:",e.audioData?e.audioData.length:"undefined"),console.log("MIME type:",e.mimeType),b(e.audioData,e.mimeType),o({success:!0}),!0;if(e.type==="STOP_AUDIO")return y(),o({success:!0}),!0;if(e.type==="GET_SELECTION"){const c=(r=window.getSelection())==null?void 0:r.toString().trim();return o({text:c||""}),!0}return e.type==="GET_VOICES"?(o({voices:[{id:"694f9389-aac1-45b6-b726-9d9369183238",name:"Default Voice",language:"en"},{id:"a0e99841-438c-4a64-b679-ae501e7d6091",name:"British Male",language:"en"},{id:"2ee87190-8f84-4925-97da-e52547f9462c",name:"American Female",language:"en"},{id:"820a3788-2b37-4d21-847a-b65d8a68c99a",name:"Australian Male",language:"en"},{id:"87748186-23bb-4158-a1eb-332911b0b708",name:"‰∏≠ÊñáÂ•≥Â£∞",language:"zh"},{id:"b9de4a89-2f3e-4f5c-9b8d-7c4a6b2f8e3d",name:"‰∏≠ÊñáÁî∑Â£∞",language:"zh"},{id:"c8ef5b9a-3f4e-5f6d-ac9e-8d5a7c3f9e4f",name:"Âè∞ÊπæÂ•≥Â£∞",language:"zh"}]}),!0):e.type==="UPDATE_AUTO_READ_SETTINGS"?(console.log("üîß Updating auto-read settings:",e.settings),console.log("üèÉ Speed changed from",a.speed,"to",e.settings.speed),a={...a,...e.settings},o({success:!0}),!0):!1});function b(e,n){console.log("üéµ playAudio function called"),console.log("Base64 data received:",e?`${e.length} characters`:"null/undefined"),console.log("MIME type:",n);try{if(y(),!e){console.error("‚ùå No audio data provided");return}console.log("üîÑ Converting base64 to blob...");const o=atob(e);console.log("Binary string length:",o.length);const r=new Uint8Array(o.length);for(let l=0;l<o.length;l++)r[l]=o.charCodeAt(l);const c=new Blob([r],{type:n});console.log("Blob created:",c.size,"bytes, type:",c.type),t=new Audio;const i=URL.createObjectURL(c);t.src=i,console.log("üéß Audio element created with URL:",i),t.onloadstart=()=>{console.log("üîÑ Audio loading started")},t.oncanplay=()=>{console.log("‚úÖ Audio can play")},t.onplay=()=>{console.log("‚ñ∂Ô∏è Started playing Cartesia audio")},t.onended=()=>{console.log("‚èπÔ∏è Finished playing audio"),s()},t.onerror=l=>{console.error("‚ùå Audio playback error:",l),console.error("Audio error event:",t==null?void 0:t.error),s()},t.onabort=()=>{console.log("‚è∏Ô∏è Audio playback aborted")},t.onstalled=()=>{console.log("‚è≥ Audio playback stalled")},t.volume=1,console.log("üöÄ Attempting to play audio..."),t.play().then(()=>{console.log("‚úÖ Audio play() promise resolved")}).catch(l=>{console.error("‚ùå Failed to play audio:",l),console.error("Error name:",l.name),console.error("Error message:",l.message),s()})}catch(o){console.error("‚ùå Error in playAudio function:",o)}}function y(){t&&(console.log("‚èπÔ∏è Stopping audio"),t.pause(),t.currentTime=0,s())}function s(){t&&(console.log("üßπ Cleaning up audio"),t.src&&URL.revokeObjectURL(t.src),t=null)}console.log("OutLoud content script loaded with Cartesia audio support and auto-read functionality");
